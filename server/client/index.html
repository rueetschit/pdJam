<!doctype html>
<html>
<head>
  <title>your personal drone</title>
  <script src="lib/socket.io.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="wrapper">

  <br>
  <br>
  <span id="title">This is your <i>personal drone</i>. </span>
  <span id="subtitle"><br>Use the sliders to shape its sound, but expect a delay of some seconds.</span>

  <audio id="audio-stream-player">
    <!-- src is set dynamically based on config -->
    <source id="audio-stream-src" src="">
    Your browser does not support the audio element.
  </audio>
  <div id="audioplayer">
    <button id="pButton" class="play" onclick="playAudio()"></button>

    <div id="volume_control">
      <input type="range" onchange="setVolume(this.value)" id="rngVolume" min="0" max="1" step="0.01" value="1">
    </div>
  </div>

  <div id="occupied-message">
    <p><strong>All drones are occupied right now, please have patience...</strong></p>
    <a id="retry-button" href="/">retry</a>
  </div>

  <div class="synth-controls">
    <div>
      <label for="frequency-slider">pitch</label><br>
      <input type="range" min="200" max="800" id="frequency-slider">
    </div>

    <div>
      <label for="attack-slider">urgency</label>
      <input type="range" min="100" max="5000" id="attack-slider">
    </div>

    <div>
      <label for="decay-slider">ease off</label>
      <input type="range" min="100" max="5000" id="decay-slider">
    </div>

    <div>
      <label for="pause-slider">decelerate</label>
      <input type="range" min="500" max="20000" id="pause-slider">
    </div>

    <div>
      <label for="length-slider">endurance</label>
      <input type="range" min="100" max="20000" id="length-slider">
    </div>

    <div>
      <label for="modfreq-slider">trill frequency</label>
      <input type="range" min="0" max="5000" id="modfreq-slider">
    </div>

    <div>
      <label for="modamount-slider">trill amount</label>
      <input type="range" min="0" max="700" id="modamount-slider">
    </div>

    <div>
      <label for="modfreq2-slider">shiver frequency</label>
      <input type="range" min="0" max="40" id="modfreq2-slider">
    </div>

    <div>
      <label for="modamount2-slider">shiver amount</label>
      <input type="range" min="0" max="100" id="modamount2-slider">
    </div>

    <div>
      <label for="lfo-slider">dissonance</label>
      <input type="range" min="0" max="100" id="lfo-slider">
    </div>

    <div>
      <label for="reverb-slider">dampness</label>
      <input type="range" min="0" max="100" id="reverb-slider">
    </div>

    <div>
      <label for="volume-slider">power</label>
      <input type="range" min="0" max="100" id="volume-slider">
    </div>
    <div id="disabled-overlay"/>
  </div>
  <br>
  <br>
  <div id="clients"><span>Drones in use: </span>
    <span id="number-of-connected-clients"></span>
    <span>/</span>
    <span id="total-number-of-clients"></span>
  </div>
</div>
<script>
  let socket = undefined;
  const occupiedMessageElement = document.getElementById('occupied-message');
  occupiedMessageElement.style.display = 'none';

  const disabledOverlay = document.getElementById('disabled-overlay');
  disabledOverlay.style.display = 'none';

  const connectedClientsInfo = document.getElementById('number-of-connected-clients');
  const totalNumberOfClientsInfo = document.getElementById('total-number-of-clients');

  const frequencySlider = document.getElementById("frequency-slider");
  const attackSlider = document.getElementById("attack-slider");
  const decaySlider = document.getElementById("decay-slider");
  const pauseSlider = document.getElementById("pause-slider");
  const lengthSlider = document.getElementById("length-slider");
  const modfreqSlider = document.getElementById("modfreq-slider");
  const modamountSlider = document.getElementById("modamount-slider");
  const modfreq2Slider = document.getElementById("modfreq2-slider");
  const modamount2Slider = document.getElementById("modamount2-slider");
  const lfoSlider = document.getElementById("lfo-slider");
  const reverbSlider = document.getElementById("reverb-slider");
  const volumeSlider = document.getElementById("volume-slider");

  const sliders = [frequencySlider, attackSlider, decaySlider, pauseSlider, lengthSlider, modfreqSlider, modamountSlider,
    modfreqSlider, modamount2Slider, lfoSlider, reverbSlider, volumeSlider];

  fetch('/api/config')
    .then(async (response) => {
      const config = await response.json();
      console.log('Got config: ', config);

      const audioStreamPlayer = document.getElementById('audio-stream-player');
      const audioStreamSource = document.getElementById('audio-stream-src');

      audioStreamSource.src = `${config.iceCast.host}:${config.iceCast.port}/${config.iceCast.mountPoint}`;
      audioStreamPlayer.load();

      socket = io(`${config.server}`);

      socket.on('connected_clients', (message) => {
        connectedClientsInfo.innerText = message.connected;
        totalNumberOfClientsInfo.innerText = message.total;
        console.log('Currently connected clients: ', message.connected);
      });

      // send initial (random) values
      socket.emit('init', {
        frequency: frequencySlider.value,
        attack: attackSlider.value,
        decay: decaySlider.value,
        pause: pauseSlider.value,
        length: lengthSlider.value,
        modFreq: modfreqSlider.value,
        modAmount: modamountSlider.value,
        modFreq2: modfreq2Slider.value,
        modFreq2Amount: modamount2Slider.value,
        lfo: lfoSlider.value,
        reverb: reverbSlider.value,
        volume: volumeSlider.value,
      });

      /* TODO: not implemented for now
      socket.on('pdjam_error', (message) => {
        alert(`There was an error: ${message.message}`);
        window.location.href = '/5xx.html';
      });
       */

      socket.on('occupied', (message) => {
        alert(message.message);
        sliders.forEach(s => s.setAttribute('disabled', 'true'));
        occupiedMessageElement.style.display = 'block';
        disabledOverlay.style.display = 'block'
      });

      frequencySlider.onchange = (slider) => socket.emit('value_change', {frequency: slider.target.value});
      attackSlider.onchange = (slider) => socket.emit('value_change', {attack: slider.target.value});
      decaySlider.onchange = (slider) => socket.emit('value_change', {decay: slider.target.value});
      pauseSlider.onchange = (slider) => socket.emit('value_change', {pause: slider.target.value});
      lengthSlider.onchange = (slider) => socket.emit('value_change', {length: slider.target.value});
      modfreqSlider.onchange = (slider) => socket.emit('value_change', {modFreq: slider.target.value});
      modamountSlider.onchange = (slider) => socket.emit('value_change', {modAmount: slider.target.value});
      modfreq2Slider.onchange = (slider) => socket.emit('value_change', {modFreq2: slider.target.value});
      modamount2Slider.onchange = (slider) => socket.emit('value_change', {modFreq2Amount: slider.target.value});
      lfoSlider.onchange = (slider) => socket.emit('value_change', {lfo: slider.target.value});
      reverbSlider.onchange = (slider) => socket.emit('value_change', {reverb: slider.target.value});
      volumeSlider.onchange = (slider) => socket.emit('value_change', {volume: slider.target.value});

      const randomIntBetween = (min, max) => { // min and max included
        return Math.floor(Math.random() * (max - min + 1) + min);
      };

      sliders.forEach(slider => slider.value = randomIntBetween(slider.min, slider.max));
    })
    .catch(e => console.log('Error fetching config: ', e));


  var music = document.getElementById('audio-stream-player');

  function playAudio() {
    if (music.paused) {
      music.play();
      pButton.className = "";
      pButton.className = "pause";
    } else {
      music.pause();
      pButton.className = "";
      pButton.className = "play";
    }
  }

  function setVolume(volume) {
    music.volume = volume;
  }
</script>
</body>
</html>
